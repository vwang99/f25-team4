<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tether Room</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="header">
    <span class="header-title">Tether</span>
    <nav class="nav-links">
      <a href="index.html" class="nav-link">Chat Rooms</a>
      <a href="profile.html" class="nav-link">Profile</a>
    </nav>
  </div>

  <div class="main-content">
    <h1 id="roomTitle">Chatroom</h1>

    <section class="messages-section">
      <div class="messages-title">Messages</div>
      <ul id="messageList"></ul>
    </section>

    <section class="add-message-section">
      <form id="messageForm">
        <input type="text" id="messageContent" placeholder="Type your message..." required />
        <button type="submit">Send</button>
      </form>
    </section>
  </div>

  <script>
    const API_BASE = "http://localhost:8080";

    // Get chatRoomId from URL query string
    const urlParams = new URLSearchParams(window.location.search);
    const chatRoomId = urlParams.get("roomId");

    // ✅ Load messages for this chatroom
    function loadMessages() {
      fetch(`${API_BASE}/chatrooms/${chatRoomId}/messages`)
        .then(res => res.json())
        .then(messages => {
          const list = document.getElementById("messageList");
          list.innerHTML = "";
          messages.forEach(msg => {
            const li = document.createElement("li");
            li.textContent = `${msg.sender.displayName}: ${msg.content} (${msg.timestamp})`;

            // Delete button
            const delBtn = document.createElement("button");
            delBtn.textContent = "Delete";
            delBtn.onclick = () => deleteMessage(msg.id);
            li.appendChild(delBtn);

            // Update button
            const updBtn = document.createElement("button");
            updBtn.textContent = "Update";
            updBtn.onclick = () => updateMessage(msg.id, "Edited content");
            li.appendChild(updBtn);

            list.appendChild(li);
          });
        })
        .catch(err => console.error("Error loading messages:", err));
    }

    // ✅ Post new message
    function postMessage(content) {
      // Example: senderId = 1 (replace with logged-in user)
      const senderId = 1;
      fetch(`${API_BASE}/messages`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: content,
          sender: { id: senderId },
          chatRoom: { id: chatRoomId }
        })
      })
        .then(res => res.json())
        .then(() => loadMessages())
        .catch(err => console.error("Error posting message:", err));
    }

    // ✅ Update message
    function updateMessage(messageId, newContent) {
      fetch(`${API_BASE}/messages/${messageId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: newContent })
      })
        .then(res => res.json())
        .then(() => loadMessages())
        .catch(err => console.error("Error updating message:", err));
    }

    // ✅ Delete message
    function deleteMessage(messageId) {
      fetch(`${API_BASE}/messages/${messageId}`, { method: "DELETE" })
        .then(() => loadMessages())
        .catch(err => console.error("Error deleting message:", err));
    }

    // ✅ Hook form submission
    document.getElementById("messageForm").addEventListener("submit", e => {
      e.preventDefault();
      const content = document.getElementById("messageContent").value;
      postMessage(content);
      document.getElementById("messageContent").value = "";
    });

    // Initial load
    loadMessages();
  </script>
</body>
</html>
